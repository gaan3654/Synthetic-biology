<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src='js/draw_graph.js'> </script>
        <script type="text/javascript" src='js/runge-kutta-method.js'> </script>
        <script type="text/javascript" src='js/replace_symb_w_func.js'> </script>
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js"></script>
        <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
        <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
        <link type="text/css" rel="stylesheet" href="style.css">
        <title>Differential equation solver</title><meta charset="utf-8"/>
    </head>
    <body>
        <header class="mainDetails ">
            <div class="mainDetails__photo">
                <img src="../assets/graph-logo.png" alt="Logo">
            </div>
            <div class="mainDetails__info">
                <h2>Diferencialinių lygčių sistemų sprendimas</h2>
                <h3>Paremta Runge-Kutta metodu</h3>
            </div>
            <!-- <div class="mainDetails__contact">
                <a href="mailto:gabriele.anuzyte@mif.stud.vu.lt">e: gabriele.anuzyte@mif.stud.vu.lt</a> <br>
                <a href="mailto:dominika.barilovic@mif.stud.vu.lt">e: dominika.barilovic@mif.stud.vu.lt</a> <br>
                <a href="http://vu.lt">w: www.vu.lt</a> <br>

                <button id=info >Info</button>
                <div id="dialog">
                    <br><strong>Sistemos naudojimas specifinėms funkcijoms.</strong><br><br>
                    <ul>
                        <li>Trigonometrinės lygties pavyzdys:
                            <ul>
                                <li>cos(lygtis)</li>
                                <li>acos(lygtis)</li>
                            </ul>
                        </li>
                        <li>Šaknies traukimas:
                                <ul>
                                    <li>sqrt(lygtis)</li>
                                    <li>cbrt(lygtis)</li>
                                </ul>
                            </li>
                        </li>
                        <li>Kėlimui laipsniu:
                                <ul>
                                    <li>pagrindas^laipsnis</li>
                                </ul>
                            </li>
                        </li>
                        <li>Logaritmai:
                                <ul>
                                    <li>log(pagrindas,logaritmuojamas reiškinys</li>
                                    <li>ln(lygtis)</li>
                                </ul>
                            </li>
                        </li>
                        <li>Konstantos:
                                <ul>
                                    <li>pi</li>
                                    <li>e</li>
                                </ul>
                            </li>
                        </li>
                    </ul> 
                </div>
            </div>  -->
        </header>
        <div>    
            <div id="substance_input">
                
                <div id=substance>  
                    <div class=input_blocks>
                        [A']:
                        <input type="number" id="A" value="2"> 
                        <input type="color" id="colorA" class="s_colors" value="#ff0000">
                    </div>
                    <div class=input_blocks>
                        [B']:
                        <input type="number" id="B" value="3"> 
                        <input type="color" id="colorB" class="s_colors" value="#0000ff">
                    </div>
                    <div class=input_blocks>
                        [C']:
                        <input type="number" id="C" value="1"> 
                        <input type="color" id="colorC" class="s_colors" value="#00ff00">
                    </div>
                </div>
                

                <div id=inputs>
                    <div id=interv_begins class=input_blocks>
                        Intervalo pradžia: 
                        <input type="number" id="int_begins" value="0"> 
                    </div> 
                    
                    <div id=interv_ends class=input_blocks> 
                        Intervalo pabaiga:
                        <input type="number" id="int_ends" value="1"> 
                    </div>                    
                    <div id=N class=input_blocks>
                        N:                
                        <input type="number" id="n_inp" value="100"> 
                    </div> 
                    <div id = reactions>
                        <div id = reaction_info_0>
                            <div id=reaction_0 class=input_blocks>
                                Įveskite norimą reakciją:
                                <input type="text" id="reaction_input_0" value="A+B->C+B">
                            </div>
                            <div id=k1_0 class=input_blocks>
                                Reakcijos greitis k<sub>1</sub>:
                                <input type="number" id="reaction_rate_0" value="0.9">
                            </div>
                            <div id=k2_0 class=input_blocks>
                                Reakcijos greitis k<sub>2</sub>:
                                <input type="number" id="second_reaction_rate_0" value="0.1">
                            </div>
                        </div>
                    </div>
                 </div>

                
            </div>
          
            
            <div class="subs_react_buttons">
                <button id=add_subs>Pridėti medžiagą</button>
                <input type="button" id=submit_reaction onclick="renew_button()" value="Vykdyti reakciją(as)"/>
                <input type="button" id=add_reaction value="Pridėti reakciją"/>
            </div>

            <div id="graph_draw">
                <div id=function_block>
                    <div id=function>
                        <!--Talpinamos reakcijos sukurtos funkcijos-->
                    </div>
                    <div class="visimygtukai">
                            <div id=dumygtukai>
                                <button id=submit style="display:none">Piešti grafiką</button>
                                <!-- <button id=delete onclick="window.location.reload(true);" style="display:none">Išvalyti</button> -->
                            </div>
                    </div>
                </div>

                <div id=canvas class=canvas>
                    <canvas id="myCanvas" width="420" height="420" style="border:1px solid #000000;">
                        Your browser does not support the HTML5 canvas tag.
                    </canvas>
                </div>
            </div>

        </div>

        <script>
            //jQuery pranešimui gauti
            $(document).ready(function() {
            $(function() {
                $( "#dialog" ).dialog({
                    autoOpen: false,
                    title: 'Info',
                    width: 500,
                    height: 300,
                    show: {
                        effect: "slide",
                        duration: 1000
                    },
                    hide: {
                        effect: "fade",
                        duration: 1000
                    }
                    
                });
            });

            $("#info").click(function(){
                    $( "#dialog" ).dialog('open');
                });
            }); 

            //Sukuriamas laukas grafikui
            var c = document.getElementById("myCanvas");
            var ctx = c.getContext("2d");
            draw(ctx);

            //Kreivių piešimas
            document.getElementById("submit").addEventListener("click", function(event) {
                var int_begin = parseFloat(document.getElementById("int_begins").value);
                var int_end = parseFloat(document.getElementById("int_ends").value);
                var N = parseInt(document.getElementById("n_inp").value);

                //Į objektą talpinami duomenis apie medžiagas: 
                // Vietą masyvę; Pradinę koncentraciją; Spalvą; 
                // Pasikartojimų kiekį; Buvimą kairėje ar dešinėje reakcijos pusėse
                var substance_obj = [];
                let possition = 0;

                for(var i = 0; i < reactions_id.length; i++){
                    console.log(i);
                    var get_reaction = document.getElementById(`reaction_input_${i}`).value;
                    get_reaction = get_reaction.split(/<?->/);
                    get_reaction[0] = get_reaction[0].replace(/\+/g, '');
                    get_reaction[1] = get_reaction[1].replace(/\+/g, '');
                    var func_array = [
                        replace_symbols(document.getElementById(`reaction_side0_${i}`).value),
                        replace_symbols(document.getElementById(`reaction_side1_${i}`).value)
                    ];
                    //["ABCB"]
                    var substance_array;
                    substance_array = func_array[0].replace(/\W|\d/g,"");
                
                
                    //["A", "B", "C", "B"]
                    var subs_arr_left = substance_array.split("");
                    for(let i=0; i<substance_array.length; i++){
                        //Nepridedamos dulikuotos medžiagų reikšmės
                        var check_array = 0;
                        for(let j=0; j<substance_obj.length; j++){
                            if (subs_arr_left[i] in substance_obj[j]){
                                check_array = 1;
                                substance_obj[j]["repetitions"]++;
                                for(let n=0; n<get_reaction[0].length; n++){
                                    if(get_reaction[0].match(new RegExp(subs_arr_left[i], 'g')) && 
                                    get_reaction[1].match(new RegExp(subs_arr_left[i], 'g'))){
                                        substance_obj[j]["occurrences"] = "both";
                                    }
                                }
                            }
                        }
                        if (check_array == 0){
                            var obj ={};
                            obj[subs_arr_left[i]] = `y[${possition++}][0]`;
                            obj[`initial_conc`] = parseFloat(document.getElementById(`${subs_arr_left[i]}`).value); 
                            obj["color"] = document.getElementById(`color${subs_arr_left[i]}`).value;
                            obj["repetitions"] = 1;
                            for(let n=0; n<get_reaction[0].length; n++){
                                if(get_reaction[0].match(new RegExp(subs_arr_left[i], 'g'))){
                                    obj["occurrences"] = "left";
                                } else {
                                    obj["occurrences"] = "right";
                                }
                            }
                            substance_obj.push(obj);
                        }
                    }
                }
                // {A: "y[0][0]", initial_conc: 2, color: "#ff0000", repetitions: 1, occurrences: "left"}
                // {B: "y[1][0]", initial_conc: 3, color: "#0000ff", repetitions: 2, occurrences: "both"}
                // {C: "y[2][0]", initial_conc: 1, color: "#00ff00", repetitions: 1, occurrences: "right"}
                
                //Dabar reikia, kad susimergintų pirmosios reakcijos rezultatai su antrosios
                console.log(substance_obj);
                console.log(get_reaction);
                //Apskaičiuojamos y reikšmės
                var [yy, tt] = solution(substance_obj, int_begin, int_end, N, func_array, get_reaction);
                //Atnaujinamas grafikas
                draw(ctx);
                normalize_and_draw(yy, tt, int_begin, int_end, c.height, c.width, substance_obj);

                //Piešiami skičiai prie grafiko ašių
                axle_numbers(N, y_max, int_end);
                    
            });

            
            var button_clicked = false;
            //Užpildomi funkcijų laukai iš pateiktos reakcijos
            document.getElementById("submit_reaction").addEventListener("click", function(event) {
                var d = document.getElementById("function");
                //Sugeneruojamos funkcijos abiem reakcijos pusėms
                var reaction_left = [];
                var reaction_right = [];
                for(var i = 0; i < reactions_id.length; i++){
                    var get_rate = document.getElementById(`reaction_rate_${i}`).value;
                    var get_rate_2 = document.getElementById(`second_reaction_rate_${i}`).value;
                    var get_reaction = document.getElementById(`reaction_input_${i}`).value;
                    var reaction = get_reaction.split(/<?->/);
                    reaction[0] = reaction[0].replace(/\+/g, "*");
                    reaction[1] = reaction[1].replace(/\+/g, "*");
                    reaction_left[i] = reaction[0] + `*(-${get_rate})` + `+` +  reaction[1] + `*${get_rate_2}`;
                    reaction_right[i] = reaction[0] + `*${get_rate}` + `+` + reaction[1] + `*(-${get_rate_2})` ;
                }
                
                // Sukuriami input laukai funkcijoms paleidus programą pirmą kartą
                if(!button_clicked){
                    for(var i = last_added_reaction_id+1; i < reactions_id.length; i++){
                        d.innerHTML += 
                        `<div class=input_blocks>
                            ${i+1}. Kairioji: 
                            <input type="text" id="reaction_side0_${i}" value=${reaction_left[i]}>
                        </div>
                        <div class=input_blocks>
                            ${i+1}. Dešinioji: 
                            <input type="text" id="reaction_side1_${i}" value=${reaction_right[i]}>
                        </div>`;
                        last_added_reaction_id = i;
                    }
                    $("#submit").css("display","inline")
                    $("#delete").css("display","inline")
                    button_clicked = true;
                } else{
                    for(var i = 0; i < reactions_id.length; i++){
                        document.getElementById(`reaction_side0_${i}`).value = reaction_left[i];
                        document.getElementById(`reaction_side1_${i}`).value = reaction_right[i];
                    }
                }
            });


            var subs_names = ["A","B","C"];
            var subs_color_id = ["colorA", "colorB", "colorC"];
            var subs_color = ["#ff0000", "#0000ff", "#00ff00", "#ffff00", "#ff9900", "#00ff99", "#0099ff", "#9900ff", "#990099", "#009900"];
            var subs_html_name = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];
            
            //Prideda papildomų medžiagų input laukų
            document.getElementById("add_subs").addEventListener("click", function(event){
                var d = document.getElementById("substance");
                // var subs_count = parseInt(document.getElementById("subs_counter").value);
                var substance_count = subs_color_id.length+1;//subs_count;
                for(var i=subs_color_id.length; i<substance_count; i++){
                    subs_names[i] = subs_html_name[i];
                    subs_color_id[i] = "color"+subs_html_name[i];
                    //Išnaudojus nustatytas spalvas, jos funkcijoms priskiriamos atsitiktinai
                    if(subs_color[i] == null){
                        subs_color[i] = getRandomColor();
                        //Tikrinama ar tokia spalva jau nėra priskirta
                        for(var j=0; j<subs_color.length-1; j++){
                            if(subs_color[i]==subs_color[j]){
                                subs_color[i] = getRandomColor();
                                j = 0;
                            }
                        }
                    }
                    //Pridedami įvesties laukai papildomoms funkcijoms
                    d.innerHTML += 
                    `<div class=input_blocks>
                        [${subs_html_name[i]}']: <input id=${subs_names[i]} type='text' value=0>
                        <input type="color" id=${subs_color_id[i]} class="s_colors" value=${subs_color[i]}>
                    </div>`;

                    //išvalome pridėti funkcijos mygtuką ir įvesties lauką.
                    // var button = document.getElementById("add_subs")
                    // button.style.display = 'none'
                    // var counter_input_field = document.getElementById("count_subst")
                    // counter_input_field.style.display = 'none'


                }
            });

            // Pakeičiamas mygtuko pavadinimas
            function renew_button() {
                document.getElementById("submit_reaction").value = "Atnaujiti reakciją(as)";
            } 

            var reactions_id = ["reaction_0"];
            var last_added_reaction_id = -1;

            //Prideda papildomų medžiagų input laukų
            document.getElementById("add_reaction").addEventListener("click", function(event){
                var d = document.getElementById("inputs");
                var i = reactions_id.length;
                reactions_id[i] = "reaction_"+[i];
                //Pridedami įvesties laukai papildomoms funkcijoms
                d.innerHTML += 
                `<div id = reaction_info_${[i]}>
                    <div id=reaction_${[i]} class=input_blocks>
                        Įveskite norimą reakciją:
                        <input type="text" id="reaction_input_${[i]}" value="A->B">
                    </div>
                    <div id=k1_${[i]} class=input_blocks>
                        Reakcijos greitis k1:
                        <input type="number" id="reaction_rate_${[i]}" value="0.9">
                    </div>
                    <div id=k2_${[i]} class=input_blocks>
                        Reakcijos greitis k2:
                        <input type="number" id="second_reaction_rate_${[i]}" value="0.1">
                    </div>
                </div>`;
                button_clicked = false;
            });

              // alertai
                /*var funct_count = parseInt(document.getElementById("subs_counter").value);
                for(i=0; i<funct_count+1; i++){
                    var value = document.getElementById("func"+i).value ;
                    // iškviečiamas alert laukas jei nįšvesta funkcija
                    if(value.trim() == "") {
                        alert("Error: Tuščias įvesties laukas!");
                        return false;
                    }
                    //iškviečiamas alert laukas jei įvesta netinkama funkcija
                    //Reikia pakeisti, kad tikrintu rezultatų egzistavimą, o ne įvestą funkciją.
                    if(value.trim() == "y/t") {
                        alert("Error: Funkcija y/t neegzistuoja!");
                        return false;
                    }
                    else{
                        return true;
                    }
                }*/       
        </script>
    </body>
</html>