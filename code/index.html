<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src='js/runge-kutta-method.js'> </script>
        <script type="text/javascript" src='js/normalization.js'> </script>
        <script type="text/javascript" src='js/updateFunction.js'> </script>
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js"></script>
        <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
        <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

        <script type="text/javascript" src='js/ODE_graph.js'> </script>
        <script src="https://www.amcharts.com/lib/4/core.js"></script>
        <script src="https://www.amcharts.com/lib/4/charts.js"></script>
        <script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>

        <link type="text/css" rel="stylesheet" href="style.css">
        <title>Differential equation solver</title><meta charset="utf-8"/>
    </head>
    <body>
        <header class="mainDetails ">
            <div class="mainDetails__photo">
                <img src="../assets/graph-logo.png" alt="Logo">
            </div>
            <div class="mainDetails__info">
                <h2>Diferencialinių lygčių sistemų sprendimas</h2>
                <h3>Paremta Runge-Kutta metodu</h3>
            </div>
        </header>
        <div>    
            <div id="substance_input">
                
                <div id=substance>  
                    <div class=input_blocks>
                        [A']:
                        <input type="text" id="A" value="2"> 
                        <input type="color" id="colorA" class="s_colors" value="#ff0000">
                    </div>
                    <div class=input_blocks>
                        [B']:
                        <input type="text" id="B" value="3"> 
                        <input type="color" id="colorB" class="s_colors" value="#0000ff">
                    </div>
                    <div class=input_blocks>
                        [C']:
                        <input type="text" id="C" value="1"> 
                        <input type="color" id="colorC" class="s_colors" value="#00ff00">
                    </div>
                    <div id=count_subst>
                        Kiek medžiagų norite pridėti?
                        <input type="number" id="subs_counter" value="1">
                    </div>
                </div>
                

                <div id=inputs>
                    <div id=interv_begins class=input_blocks>
                        Intervalo pradžia: 
                        <input type="number" id="interval_begins" value="0"> 
                    </div> 
                    
                    <div id=interv_ends class=input_blocks> 
                        Intervalo pabaiga:
                        <input type="number" id="interval_ends" value="1"> 
                    </div>                    
                    <div id=N class=input_blocks>
                        N:                
                        <input type="number" id="n_inp" value="100"> 
                    </div>   
                    <div id=reaction class=input_blocks>
                        Įveskite norimą reakciją:
                        <input type="text" id="reaction_input" value="A+B->C">
                    </div>
                    <div id=reaction class=input_blocks>
                        Reakcijos greitis k1:
                        <input type="text" id="reaction_rate" value="0.9">
                    </div>
                    <div id=reaction class=input_blocks>
                        Reakcijos greitis k2:
                        <input type="text" id="second_reaction_rate" value="0.5">
                    </div>
                   
                 </div>

                
            </div>
          
            
            <div class="subs_react_buttons">
            <button id=add_subs>Pridėti medžiagą(as)</button>
            <button id=submit_reaction onclick="disablesbutton()">Vykdyti reakciją(as)</button>
            </div>

            <div id="graph_draw">
                <div id=function_block>
                    <div id=function>
                        <!--Talpinamos reakcijos sukurtos funkcijos-->
                    </div>
                    <div class="visimygtukai">
                            <div id=dumygtukai>
                                <button id=submit onclick="disablesbutton()" style="display:none">Piešti grafiką</button>
                                <button id=delete onclick="window.location.reload(true);" style="display:none">Išvalyti</button>
                            </div>
                    </div>
                </div>
                <div id="chartdiv"></div>
            </div>

        </div>

        <script>
            //Kreivių piešimas
            document.getElementById("submit").addEventListener("click", function(event) {
                let int_begin = parseFloat(document.getElementById("interval_begins").value);
                let int_end = parseFloat(document.getElementById("interval_ends").value);
                let N = parseInt(document.getElementById("n_inp").value);
                let get_reaction = document.getElementById("reaction_input").value;
                get_reaction = get_reaction.split(/<?->/);
                get_reaction[0] = get_reaction[0].replace('+', '');
                get_reaction[1] = get_reaction[1].replace('+', '');
                let func_array = [
                    document.getElementById("reaction_side0").value,
                    document.getElementById("reaction_side1").value
                ];
                let substance_array = [];
                substance_array[0] = func_array[0].replace(/\W|\d/g,"");
                substance_array[1] = func_array[1].replace(/\W|\d/g,"");
                //sukuriamas y0 reikšmių masyvas
                let y0 = substance_array[0].split("");
                let color = [];
                for(let i=0; i<substance_array[0].length; i++){
                    color[i] = document.getElementById(`color${y0[i]}`).value;
                    y0[i] = parseFloat(document.getElementById(`${y0[i]}`).value);
                }
                //Apskaičiuojamos y reikšmės
                initializeValues(y0, N, int_begin, int_end, get_reaction);
                let [y, tt] = solution(func_array);

                createChart(am4core, y, tt);
                    
            });

            

            //Užpildomi funkcijų laukai iš pateiktos reakcijos
            document.getElementById("submit_reaction").addEventListener("click", function(event) {
                let d = document.getElementById("function");
                let get_rate = document.getElementById("reaction_rate").value;
                let get_rate_2 = document.getElementById("second_reaction_rate").value;
                let get_reaction = document.getElementById("reaction_input").value;
                let reaction = get_reaction.split(/<?->/);
                //Sugeneruojamos funkcijos abiem reakcijos pusėms
                let reaction_sides = [];
                reaction[0] = reaction[0].replace(/\+/g, "*");
                reaction[1] = reaction[1].replace(/\+/g, "*");
                reaction_sides[0] = reaction[0] + `*(-${get_rate})` + `+` +  reaction[1] + `*${get_rate_2}`;
                reaction_sides[1] = reaction[0] + `*${get_rate}` + `+` + reaction[1] + `*(-${get_rate_2})` ;
                //Sukuriami input laukai funkcijoms
                //kairioji pusė
                d.innerHTML += 
                `<div class=input_blocks>
                    Kairioji: 
                    <input type="text" id="reaction_side0" value=${reaction_sides[0]}>
                </div>`;
                //dešinioji pusė
                d.innerHTML += 
                `<div class=input_blocks>
                    Dešinioji: 
                    <input type="text" id="reaction_side1" value=${reaction_sides[1]}>
                </div>`;

                $("#submit").css("display","inline")
                $("#delete").css("display","inline")
            });


            let subs_names = ["A","B","C"];
            let subs_color_id = ["colorA", "colorB", "colorC"];
            let subs_color = ["#ff0000", "#0000ff", "#00ff00", "#990099", "#ffff00", "#ff9900"];
            let subs_html_name = ["A","B","C","D","F","G","H","I","J","K","N","L","O","P","Q","R","S","T","U","V","W","X","Y","Z"];
            
            //Prideda papildomą medžiagos input lauką
            document.getElementById("add_subs").addEventListener("click", function(event){
                let d = document.getElementById("substance");
                let subs_count = parseInt(document.getElementById("subs_counter").value);
                let substance_count = subs_color_id.length+subs_count;
                for(let i=subs_color_id.length; i<substance_count; i++){
                    subs_names[i] = subs_html_name[i];
                    subs_color_id[i] = "color"+subs_html_name[i];
                    //Išnaudojus nustatytas spalvas, jos funkcijoms priskiriamos atsitiktinai
                    if(subs_color[i] == null){
                        subs_color[i] = getRandomColor();
                        //Tikrinama ar tokia spalva jau nėra priskirta
                        for(let j=0; j<subs_color.length-1; j++){
                            if(subs_color[i]==subs_color[j]){
                                subs_color[i] = getRandomColor();
                                j = 0;
                            }
                        }
                    }
                    //Pridedami įvesties laukai papildomoms funkcijoms
                    d.innerHTML += 
                    `<div class=input_blocks>
                        [${subs_html_name[i]}']: <input id=${subs_names[i]} type='text'>
                        <input type="color" id=${subs_color_id[i]} class="s_colors" value=${subs_color[i]}>
                    </div>`;

                    //išvalome pridėti funkcijos mygtuką ir įvesties lauką.
                    let button = document.getElementById("add_subs")
                    button.style.display = 'none'
                    let counter_input_field = document.getElementById("count_subst")
                    counter_input_field.style.display = 'none'


                }
            });

            //funkcija, kuri sustabdo mygtukų veikimą kai grafikas jau yra nupieštas
            function disablesbutton() {
                document.getElementById("submit_reaction").disabled = true;
                document.getElementById("add_subs").disabled = true;
            }      
        </script>
    </body>
</html>